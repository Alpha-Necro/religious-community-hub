name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      
      - name: Install dependencies
        run: yarn install
      
      - name: Build application
        run: yarn build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Deploy to AWS
        env:
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          AWS_ECS_CLUSTER: ${{ secrets.AWS_ECS_CLUSTER }}
          AWS_ECS_SERVICE: ${{ secrets.AWS_ECS_SERVICE }}
        run: |
          # Push Docker image to ECR
          $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
          docker tag religious-community-hub:latest ${{ secrets.ECR_REPOSITORY }}
          docker push ${{ secrets.ECR_REPOSITORY }}
          
          # Update ECS service
          aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --force-new-deployment
      
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          fields: job-status,commit,repo,ref,workflow
          author_name: GitHub Actions
          author_icon: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Send deployment notification
        uses: appleboy/telegram-action@master
        if: always()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            Deployment Status: ${{ job.status }}
            Environment: Production
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref }}
            Workflow: ${{ github.workflow }}
